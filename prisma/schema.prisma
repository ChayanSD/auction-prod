generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id               String           @id @default(cuid())
  stripeCustomerId String?          @unique
  accountType      AccountType      @default(Bidding)
  firstName        String
  middleName       String?
  lastName         String
  email            String           @unique
  phone            String
  password         String
  termsAccepted    Boolean
  newsletter       Boolean
  isVerified       Boolean          @default(false)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  billingAddress   BillingAddress? 
  shippingAddress  ShippingAddress? 
  payments         Payment[]
  bids             Bid[]
  invoices         Invoice[]
  contacts         Contact[]
  auctionRequests  AuctionRequest[]
  notifications    Notification[]

  @@index([email])
  @@map("users")
}

enum AccountType {
  Bidding
  Seller
  Admin
}

model BillingAddress {
  id         String  @id @default(cuid())
  user       User    @relation(fields: [userId], references: [id],onDelete: Cascade)
  userId     String  @unique
  country    String
  address1   String
  address2   String?
  city       String
  postcode   String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("billing_addresses")
}

model ShippingAddress {
  id         String  @id @default(cuid())
  user       User    @relation(fields: [userId], references: [id],onDelete: Cascade)
  userId     String  @unique
  country    String
  address1   String
  address2   String?
  city       String
  postcode   String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("shipping_addresses")
}

model Payment {
  id            String   @id @default(cuid())
  user          User     @relation(fields: [userId], references: [id])
  userId        String
  cardHolder    String
  last4         String
  expiryMonth   Int
  expiryYear    Int
  stripeId      String  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("payments")
}


model Category {
  id        String    @id @default(cuid())
  name      String    @unique
  imageUrl  String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  auctions  Auction[]

  @@map("categories")
}


model Auction {
  id          String        @id @default(cuid())
  name        String
  description String
  location    String
  slug        String         @unique
  imageUrl    String?
  // status      AuctionStatus  @default(Draft)
  tags        TagOnAuction[]
  items       AuctionItem[] 
  auctionRequests AuctionRequest[]
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  categoryId String
  category   Category       @relation(fields: [categoryId], references: [id],onDelete: Cascade)

  @@index([slug])
  // @@index([status])
  @@map("auctions")
}

// enum AuctionStatus {
//   Draft
//   Upcoming
//   Active
//   Ended
//   Cancelled
// }

model Tag {
  id        String          @id @default(cuid())
  name      String          @unique
  auctions  TagOnAuction[]
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  @@map("tags")
}

model TagOnAuction {
  auctionId String
  tagId     String
  auction   Auction @relation(fields: [auctionId], references: [id], onDelete: Cascade)
  tag       Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([auctionId, tagId])
  @@map("auction_tags")
}


model AuctionItem {
  id            String          @id @default(cuid())
  name          String
  description   String
  auctionId     String
  auction       Auction         @relation(fields: [auctionId], references: [id], onDelete: Cascade)
  
  startDate   DateTime
  endDate     DateTime
  status      AuctionItemStatus @default(Live)
  
  shipping      Json?          
  terms         String?
  baseBidPrice  Float
  additionalFee Float?           
  currentBid    Float?           @default(0)
  estimatedPrice Float?

  bids          Bid[]
  productImages ProductImage[]
  invoices      Invoice[]

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@index([auctionId])
  @@map("auction_items")
}

enum AuctionItemStatus {
  Live
  Closed
}

model Bid {
  id           String      @id @default(cuid())
  auctionItemId String
  auctionItem   AuctionItem @relation(fields: [auctionItemId], references: [id], onDelete: Cascade)
  userId       String
  user         User        @relation(fields: [userId], references: [id] , onDelete: Cascade)
  amount       Float
  createdAt    DateTime    @default(now())

  @@index([auctionItemId])
  @@map("bids")
}

model ProductImage {
  id           String      @id @default(cuid())
  auctionItemId String
  auctionItem   AuctionItem @relation(fields: [auctionItemId], references: [id], onDelete: Cascade)
  url          String
  altText      String?
  createdAt    DateTime    @default(now())

  @@map("product_images")
}

model Invoice {
  id            String      @id @default(cuid())
  invoiceNumber String      @unique // Auto-generated invoice number
  auctionItemId String
  auctionItem   AuctionItem @relation(fields: [auctionItemId], references: [id], onDelete: Cascade)
  userId        String
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Bid information
  winningBidId   String?     // Reference to the winning bid
  bidAmount     Float       // Winning bid amount
  additionalFee Float?      // Additional fees
  totalAmount   Float       // Total amount (bidAmount + additionalFee)
  
  // Stripe payment
  stripePaymentLinkId String? // Stripe checkout session ID
  stripePaymentLink   String? // Stripe payment URL
  stripeInvoiceId     String? // Stripe invoice ID
  stripePaymentIntentId String? // Stripe PaymentIntent ID for automatic payments
  
  // Status
  status        InvoiceStatus @default(Unpaid)
  paidAt        DateTime?
  
  // Admin actions
  sentBy        String?     // Admin user ID who sent the invoice
  sentAt        DateTime?
  notes         String?     // Admin notes
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([userId])
  @@index([auctionItemId])
  @@index([status])
  @@map("invoices")
}

enum InvoiceStatus {
  Unpaid
  Paid
  Cancelled
}

model Contact {
  id          String        @id @default(cuid())
  name        String
  email       String
  phone       String?
  subject     String
  message     String
  type        ContactType   @default(General)
  status      ContactStatus @default(New)
  userId      String?       // Optional: if user is logged in
  user        User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  respondedAt DateTime?
  notes       String?       // Admin notes
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([status])
  @@index([type])
  @@index([createdAt])
  @@map("contacts")
}

enum ContactType {
  General
  Consignment
  Support
  Bidding
  Other
}

enum ContactStatus {
  New
  InProgress
  Resolved
  Archived
}

model AuctionRequest {
  id          String                @id @default(cuid())
  userId      String
  user        User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // AuctionItem data
  name        String
  description String
  auctionId   String
  auction     Auction               @relation(fields: [auctionId], references: [id], onDelete: Cascade)
  
  startDate   DateTime
  endDate     DateTime
  baseBidPrice Float
  additionalFee Float?
  estimatedPrice Float?
  
  shipping    Json?                 // { address, cost, deliveryTime }
  terms       String?
  productImages Json?              // Array of { url, altText }
  
  // Status
  status      AuctionRequestStatus  @default(Pending)
  
  // Admin actions
  reviewedBy  String?               // Admin user ID who reviewed
  reviewedAt  DateTime?
  notes       String?                // Admin notes
  
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt

  @@index([userId])
  @@index([auctionId])
  @@index([status])
  @@index([createdAt])
  @@map("auction_requests")
}

enum AuctionRequestStatus {
  Pending
  Approved
  Rejected
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type      NotificationType
  title     String
  message   String
  link      String?  // URL to related item (e.g., /payment/invoiceId, /auction-item/itemId)
  read      Boolean  @default(false)
  
  // Related item IDs for filtering
  invoiceId String?
  bidId     String?
  auctionItemId String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([read])
  @@index([createdAt])
  @@map("notifications")
}

enum NotificationType {
  Invoice
  BidUpdate
  AuctionEnded
  Outbid
}