generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id               String      @id @default(cuid())
  stripeCustomerId String?     @unique
  accountType      AccountType @default(Bidding)
  firstName        String
  middleName       String?
  lastName         String
  email            String      @unique
  phone            String
  password         String
  termsAccepted    Boolean
  newsletter       Boolean
  isVerified       Boolean     @default(false)
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  billingAddress  BillingAddress?
  shippingAddress ShippingAddress?
  payments        Payment[]
  bids            Bid[]
  invoices        Invoice[]
  contacts        Contact[]
  notifications   Notification[]

  @@index([email])
  @@map("users")
}

enum AccountType {
  Bidding
  Seller
  Admin
}

model BillingAddress {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String   @unique
  country   String
  address1  String
  address2  String?
  city      String
  postcode  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("billing_addresses")
}

model ShippingAddress {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String   @unique
  country   String
  address1  String
  address2  String?
  city      String
  postcode  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("shipping_addresses")
}

model Payment {
  id          String   @id @default(cuid())
  user        User     @relation(fields: [userId], references: [id])
  userId      String
  cardHolder  String
  last4       String
  expiryMonth Int
  expiryYear  Int
  stripeId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("payments")
}

model Auction {
  id                  String         @id @default(cuid())
  name                String
  description         String
  location            String
  slug                String         @unique
  imageUrl            String?
  startDate           DateTime?
  endDate             DateTime?
  status              AuctionStatus  @default(Upcoming)
  termsAndConditions  String?        // Terms and conditions for liability (per auction)
  tags                TagOnAuction[]
  items               AuctionItem[]
  invoices            Invoice[]
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt

  @@index([slug])
  @@index([status])
  @@map("auctions")
}

enum AuctionStatus {
  Upcoming
  Live
  Closed
}

model Tag {
  id        String            @id @default(cuid())
  name      String            @unique
  auctions  TagOnAuction[]
  items     TagOnAuctionItem[]
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  @@map("tags")
}

model TagOnAuction {
  auctionId String
  tagId     String
  auction   Auction @relation(fields: [auctionId], references: [id], onDelete: Cascade)
  tag       Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([auctionId, tagId])
  @@map("auction_tags")
}

model TagOnAuctionItem {
  auctionItemId String
  tagId         String
  auctionItem   AuctionItem @relation(fields: [auctionItemId], references: [id], onDelete: Cascade)
  tag           Tag         @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([auctionItemId, tagId])
  @@map("auction_item_tags")
}

model AuctionItem {
  id          String            @id @default(cuid())
  name        String
  description String
  auctionId   String
  auction     Auction           @relation(fields: [auctionId], references: [id], onDelete: Cascade)
  lotNumber   String?           // Lot number for cataloging and invoicing

  shipping      Json?
  terms         String?
  baseBidPrice  Float
  reservePrice  Float? // Hidden reserve price
  buyersPremium Float? // Buyer's premium percentage (e.g., 20 for 20%)
  taxPercentage Float? // Tax percentage (e.g., 20 for 20%)
  currentBid    Float?  @default(0)
  estimateMin   Float? // Auctioneer's minimum estimate
  estimateMax   Float? // Auctioneer's maximum estimate
  // estimatedPrice Float?

  tags            TagOnAuctionItem[]
  bids             Bid[]
  productImages    ProductImage[]
  invoices         Invoice[]
  invoiceLineItems InvoiceLineItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([auctionId])
  @@map("auction_items")
}

model Bid {
  id            String      @id @default(cuid())
  auctionItemId String
  auctionItem   AuctionItem @relation(fields: [auctionItemId], references: [id], onDelete: Cascade)
  userId        String
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  amount        Float
  createdAt     DateTime    @default(now())

  @@index([auctionItemId])
  @@map("bids")
}

model ProductImage {
  id            String      @id @default(cuid())
  auctionItemId String
  auctionItem   AuctionItem @relation(fields: [auctionItemId], references: [id], onDelete: Cascade)
  url           String
  altText       String?
  createdAt     DateTime    @default(now())

  @@map("product_images")
}

model Invoice {
  id            String   @id @default(cuid())
  invoiceNumber String   @unique // Auto-generated invoice number
  auctionId     String? // Optional initially for migration, will be required for new invoices
  auction       Auction? @relation(fields: [auctionId], references: [id], onDelete: Cascade)
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Legacy fields (optional for backward compatibility during migration)
  auctionItemId String? // Optional - for old single-item invoices
  auctionItem   AuctionItem? @relation(fields: [auctionItemId], references: [id], onDelete: Cascade)
  winningBidId  String? // Legacy - kept for old invoices
  bidAmount     Float? // Legacy - kept for old invoices
  buyersPremium Float? // Legacy - kept for old invoices
  taxAmount     Float? // Legacy - kept for old invoices

  // New fields for combined invoices
  lineItems   InvoiceLineItem[] // Multiple items per invoice
  subtotal    Float? // Sum of all lineItems.lineTotal (optional for migration)
  totalAmount Float? // Same as subtotal (optional for migration, will use legacy totalAmount if null)

  // Stripe payment
  stripePaymentLinkId   String? // Stripe checkout session ID
  stripePaymentLink     String? // Stripe payment URL
  stripeInvoiceId       String? // Stripe invoice ID
  stripePaymentIntentId String? // Stripe PaymentIntent ID for automatic payments

  // Status
  status InvoiceStatus @default(Unpaid)
  paidAt DateTime?

  // Admin actions
  sentBy String? // Admin user ID who sent the invoice
  sentAt DateTime?
  notes  String? // Admin notes

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([auctionId])
  @@index([status])
  @@map("invoices")
}

model InvoiceLineItem {
  id            String      @id @default(cuid())
  invoiceId     String
  invoice       Invoice     @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  auctionItemId String
  auctionItem   AuctionItem @relation(fields: [auctionItemId], references: [id], onDelete: Cascade)

  // Winning bid info
  winningBidId String? // Reference to the winning bid
  bidAmount    Float // Hammer price (winning bid amount)

  // Fees (calculated from item's percentages)
  buyersPremium Float // Calculated: bidAmount * (item.buyersPremium / 100)
  taxAmount     Float // Calculated: (bidAmount + buyersPremium) * (item.taxPercentage / 100)
  lineTotal     Float // bidAmount + buyersPremium + taxAmount

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([invoiceId])
  @@index([auctionItemId])
  @@map("invoice_line_items")
}

enum InvoiceStatus {
  Unpaid
  Paid
  Cancelled
}

model Contact {
  id          String        @id @default(cuid())
  name        String
  email       String
  phone       String?
  subject     String
  message     String
  type        ContactType   @default(General)
  status      ContactStatus @default(New)
  userId      String? // Optional: if user is logged in
  user        User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  respondedAt DateTime?
  notes       String? // Admin notes
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([status])
  @@index([type])
  @@index([createdAt])
  @@map("contacts")
}

enum ContactType {
  General
  Consignment
  Support
  Bidding
  Other
}

enum ContactStatus {
  New
  InProgress
  Resolved
  Archived
}

model AuctionRequest {
  id              String  @id @default(cuid())
  // AuctionItem data
  itemName        String?
  itemDescription String?

  productImages Json? // Array of { url, altText }

  // Status
  status AuctionRequestStatus @default(Pending)

  // Admin actions
  reviewedBy String?
  reviewedAt DateTime?
  notes      String?

  //User data
  name  String
  email String
  phone String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([createdAt])
  @@map("auction_requests")
}

enum AuctionRequestStatus {
  Pending
  Approved
  Rejected
}

model Notification {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type    NotificationType
  title   String
  message String
  link    String? // URL to related item (e.g., /payment/invoiceId, /auction-item/itemId)
  read    Boolean          @default(false)

  // Related item IDs for filtering
  invoiceId     String?
  bidId         String?
  auctionItemId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([read])
  @@index([createdAt])
  @@map("notifications")
}

enum NotificationType {
  Invoice
  BidUpdate
  AuctionEnded
  Outbid
}
